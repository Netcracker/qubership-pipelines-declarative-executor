kind: AtlasPipeline
apiVersion: v2

pipeline:
  id: pipeline-complex
  name: Complex Parallel Pipeline with ATLAS_PIPELINE_TRIGGER (aka NESTED_PIPELINE)
  vars:
    STAGE_TYPE_PY: PYTHON_MODULE
    STAGE_TYPE_NESTED: ATLAS_PIPELINE_TRIGGER
    TEST_TOKEN: qwerty123
    ENABLE_RANDOM_SLEEP: true

  stages:
    - name: Spam Before Parallel
      job: template-spam-stage
      input:
        params:
          params:
            sleep_time: 0

    - name: parallel parent
      parallel:
      - name: Spam Inside Parallel 1
        job: template-spam-stage

      - name: Spam Inside Parallel 2
        job: template-spam-stage

      - name: Spam Inside Parallel 3
        job: template-spam-stage

    - name: Spam After Parallel
      job: template-spam-stage
      input:
        params:
          params:
            sleep_time: 0

    - name: Trigger Another Pipeline Lv.2
      type: ${STAGE_TYPE_NESTED}
      input:
        pipeline_data: |
          ${PIPELINE_DATA_DIR}/pipeline_linear.yaml
        pipeline_vars: |
          OVER_PARAM_1 = 123
          OVER_PARAM_2 = 4124
          PIPELINE_DATA_DIR = ${PIPELINE_DATA_DIR}
          ENABLE_RANDOM_SLEEP = ${ENABLE_RANDOM_SLEEP}
        is_dry_run: false
      output:
        params:
          params: "*"
        files:
          EVERYTHING_FROM_NESTED: "*"

#    - name: System Load Test
#      job: template-system-load-test

#    - name: Run GitHub Pipeline
#      job: template-github-run-pipeline

  jobs:
    template-spam-stage:
      type: ${STAGE_TYPE_PY}
      command: "spam"
      input:
        params:
          params:
            param_count: 3
            sleep_time: 0.5
            sleep_period: 0.1
            random_sleep: ${ENABLE_RANDOM_SLEEP}
            print_all_level_logs: true
        params_secure:
          systems:
            qubership:
              token: ${TEST_TOKEN}
      output:
        params:
          RESULT_SPAM: "params.some_insecure_param_0"

    template-system-load-test:
      type: ${STAGE_TYPE_PY}
      command: "system-load-test"
      input:
        params:
          params:
            cpu:
              run_test: true
              load: 1
              duration: 2
            ram:
              run_test: true
              size_mb: 100
              duration: 2
              chunks: 2

    template-github-run-pipeline:
      type: ${STAGE_TYPE_PY}
      command: "github-run-pipeline"
      input:
        params:
          params:
            pipeline_owner: LightlessOne
            pipeline_repo_name: test-workflow
            pipeline_workflow_file_name: test.yaml
        params_secure:
          systems:
            github:
              password: ${GH_TOKEN}

  configuration:
    output:
      params:
        RESULT_SPAM: ${RESULT_SPAM}
